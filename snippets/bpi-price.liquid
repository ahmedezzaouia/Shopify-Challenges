{% comment %}
  Accepts:
  - product: {Object} Product Liquid object (required)
  Usage:
  {% render 'bpi-price', product: product %}

  Please note that this file is automatically generated and can be overwritten, for customization please create a copy.
{% endcomment %}

{%- liquid
  assign target = product.selected_or_first_available_variant
  assign initialId = target.id
  assign compare_at_price = target.compare_at_price
  assign bpi_price = target.metafields.bpi.price
  assign money_price = bpi_price | money | strip_html
-%}

{%- if compare_at_price > target.price and bpi_price != null and target.price != price and bpi_price != 'N/A' -%}
  {%- style -%}
  .bpi-price {
    font-size: small;
    display: block;
    width: 100%;
    text-align: inherit;
    transition: opacity 200ms ease-in-out;
  }
  {%- endstyle -%}

  <span class="bpi-price" data-bpi-product="{{ product.id }}" style="opacity: {% if compare_at_price > target.price %}1{% else %}0{% endif %};">{{ 'bpi.content' | t: price: money_price }}</span>

  {%- if template == 'product' -%}
    <script type="application/json" data-bpi-prices>
      {
        "product": {{ product.id }},
        "label": {{ 'bpi.content' | t | json }},
        "initialId": {{ initialId | json}},
        "variantPrices": {
          {% for variant in product.variants -%}
          "{{ variant.id }}":
            {
              "price": {{ variant.price | json }},
              "compareAtPrice": {{ variant.compare_at_price | json }},
              "priceLabel": {{ variant.metafields.bpi.price | money | strip_html | json }},
              "bpiPrice": {{ variant.metafields.bpi.price }}
            }{% unless forloop.last %},{% endunless -%}
          {%- endfor %}
        }
      }
    </script>
    <script data-bpi-script-url>{{ 'bpi-price.js' | asset_url }}</script>

    <script type="application/javascript">
      window.addEventListener('load', () => {
        // skip if script is already loaded
        if (document.querySelector('[data-bpi-script]')) return;

        // append script to document
        const script = document.createElement('script');
        script.setAttribute('data-bpi-script', '');
        script.src = document.querySelector('[data-bpi-script-url]').textContent;
        document.body.appendChild(script);
      });
    </script>
  {%- endif -%}
{%- endif -%}
